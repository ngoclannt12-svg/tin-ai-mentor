<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H·ªá th·ªëng TIN-AI Mentor - Adaptive Learning</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --blue-600:#2563eb; --blue-700:#1d4ed8; --slate-100:#f1f5f9; --white:#ffffff; --orange: #ff6b3d; --green:#10b981;}
    body { margin: 0; font-family: "Be Vietnam Pro", sans-serif; background: var(--slate-100); color: #333; }
    .container { width: min(1100px, calc(100% - 40px)); margin: 0 auto; padding: 20px 0; }
    .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    select, input { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
    .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s; }
    .btn-main { background: var(--blue-600); color: white; width: 100%; margin-top: 15px; }
    .option { display: block; padding: 10px 15px; border: 1px solid #eee; border-radius: 10px; margin-top: 8px; cursor: pointer; }
    .option.selected { background: #e0f2fe; border-color: var(--blue-600); font-weight: 600; }
    #quiz-section, #result-section, #history-section { display: none; }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; color: white; text-transform: uppercase; }
    .ai-feedback { border-left: 5px solid var(--orange); background: #fffcf9; padding: 20px; border-radius: 0 15px 15px 0; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div id="setup-section" class="card">
      <h2>üöÄ Ch√†o m·ª´ng ƒë·∫øn v·ªõi TIN-AI Mentor</h2>
      <p>H·ªá th·ªëng t·ª± ƒë·ªông sinh ƒë·ªÅ v√† ph√¢n t√≠ch nƒÉng l·ª±c theo t·ª´ng c√° nh√¢n.</p>
      <div class="grid">
        <div>
          <label>T√™n h·ªçc sinh:</label>
          <input type="text" id="student-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        </div>
        <div>
          <label>Ch·ªçn ch·ªß ƒë·ªÅ ki·∫øn th·ª©c:</label>
          <select id="topic">
            <option value="Bi·∫øn, ki·ªÉu d·ªØ li·ªáu v√† to√°n t·ª≠ trong Python">Bi·∫øn v√† Ki·ªÉu d·ªØ li·ªáu</option>
            <option value="C·∫•u tr√∫c r·∫Ω nh√°nh if-else v√† logic">C·∫•u tr√∫c r·∫Ω nh√°nh</option>
            <option value="V√≤ng l·∫∑p for, while v√† l·ªánh range">V√≤ng l·∫∑p</option>
            <option value="H√†m (Functions) v√† tham s·ªë">H√†m v√† Module</option>
            <option value="X·ª≠ l√Ω danh s√°ch (List) v√† chu·ªói">Chu·ªói v√† Danh s√°ch</option>
          </select>
        </div>
      </div>
      <button class="btn btn-main" onclick="generateQuizByAI()">AI kh·ªüi t·∫°o ƒë·ªÅ thi 12 c√¢u (4-4-4)</button>
      <button onclick="showHistory()" style="margin-top:15px; background:none; border:none; color:var(--blue-600); cursor:pointer; text-decoration:underline; width:100%">Xem b√°o c√°o ti·∫øn b·ªô & L·ªãch s·ª≠ l√†m b√†i</button>
    </div>

    <div id="quiz-section">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; position: sticky; top: 10px; z-index: 100;">
        <h3 id="quiz-title" style="margin:0">ƒêang l√†m b√†i...</h3>
        <div id="timer" style="color:var(--orange); font-weight:bold; font-size:1.2em;">15:00</div>
      </div>
      <div id="quiz-content"></div>
      <button class="btn btn-main" id="submit-btn" onclick="submitQuiz()">N·ªôp b√†i & Ph√¢n t√≠ch nƒÉng l·ª±c</button>
    </div>

    <div id="result-section">
      <div class="grid">
        <div class="card">
          <h3>Th·ªëng k√™ nƒÉng l·ª±c</h3>
          <canvas id="radarChart"></canvas>
          <h2 id="final-score" style="text-align:center; color:var(--blue-700); margin-top:20px;"></h2>
        </div>
        <div class="card">
          <h3>ü§ñ Gia s∆∞ AI h∆∞·ªõng d·∫´n t∆∞ duy</h3>
          <div id="ai-feedback" class="ai-feedback"></div>
          <button class="btn btn-main" onclick="location.reload()">L√†m b√†i t·∫≠p m·ªõi</button>
        </div>
      </div>
    </div>

    <div id="history-section" class="card">
      <h2>üìà B√°o c√°o ti·∫øn b·ªô h·ªçc t·∫≠p</h2>
      <div style="height: 300px; margin-bottom: 30px;">
        <canvas id="lineChart"></canvas>
      </div>
      <h3>L·ªãch s·ª≠ chi ti·∫øt</h3>
      <div id="history-list"></div>
      <button class="btn btn-main" onclick="location.reload()">Quay l·∫°i trang ch·ªß</button>
    </div>
  </div>

  <script>
    const GEMINI_API_KEY = "AIzaSyAedSTFlNgtJNI280S0Px67swwl1ONIC-8"; //
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    
    let currentQuestions = [];
    let studentName = "";

    // AI T·ª∞ ƒê·ªòNG SINH 12 C√ÇU H·ªéI (4-4-4)
    async function generateQuizByAI() {
      studentName = document.getElementById('student-name').value;
      if(!studentName) return alert("Vui l√≤ng nh·∫≠p t√™n!");
      const topic = document.getElementById('topic').value;
      
      document.getElementById('setup-section').style.display = 'none';
      document.getElementById('quiz-section').style.display = 'block';
      document.getElementById('quiz-content').innerHTML = "<div class='card'><h3>‚è≥ AI ƒëang thi·∫øt k·∫ø ƒë·ªÅ thi ri√™ng cho b·∫°n...</h3><p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.</p></div>";

      const prompt = `B·∫°n l√† chuy√™n gia so·∫°n ƒë·ªÅ thi Tin h·ªçc. H√£y t·∫°o 12 c√¢u h·ªèi tr·∫Øc nghi·ªám v·ªÅ ch·ªß ƒë·ªÅ "${topic}". 
      Y√™u c·∫ßu nghi√™m ng·∫∑t:
      - 4 c√¢u m·ª©c Nh·∫≠n bi·∫øt (nb), 4 c√¢u m·ª©c Th√¥ng hi·ªÉu (th), 4 c√¢u m·ª©c V·∫≠n d·ª•ng (vd).
      - ƒê·ªãnh d·∫°ng tr·∫£ v·ªÅ duy nh·∫•t m√£ JSON (kh√¥ng c√≥ text kh√°c): [{"q": "c√¢u h·ªèi", "o": ["A","B","C","D"], "a": index_ƒë√∫ng, "l": "nb/th/vd"}].`;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await response.json();
        const jsonText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '');
        currentQuestions = JSON.parse(jsonText);
        renderQuiz(topic);
        startTimer();
      } catch (e) {
        alert("L·ªói k·∫øt n·ªëi AI khi t·∫°o ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i!");
        location.reload();
      }
    }

    function renderQuiz(topic) {
      document.getElementById('quiz-title').innerText = topic;
      const content = document.getElementById('quiz-content');
      content.innerHTML = "";
      currentQuestions.forEach((item, i) => {
        const color = item.l == 'nb' ? '#0369a1' : (item.l == 'th' ? '#92400e' : '#166534');
        const levelTxt = item.l == 'nb' ? 'Nh·∫≠n bi·∫øt' : (item.l == 'th' ? 'Th√¥ng hi·ªÉu' : 'V·∫≠n d·ª•ng');
        content.innerHTML += `<div class="card">
          <span class="badge" style="background:${color}">${levelTxt}</span>
          <p style="font-size:1.1em; margin-top:10px;"><b>C√¢u ${i+1}:</b> ${item.q}</p>
          <div class="options">
            ${item.o.map((opt, oi) => `<label class="option" id="q${i}o${oi}"><input type="radio" name="q${i}" value="${oi}" style="display:none" onclick="selectOpt(${i},${oi})"> ${opt}</label>`).join('')}
          </div>
        </div>`;
      });
    }

    function selectOpt(qI, oI) {
      document.querySelectorAll(`[id^="q${qI}o"]`).forEach(el => el.classList.remove('selected'));
      document.getElementById(`q${qI}o${oI}`).classList.add('selected');
    }

    async function submitQuiz() {
      let score = 0;
      let stats = { nb: 0, th: 0, vd: 0 };
      let wrongs = [];

      currentQuestions.forEach((item, i) => {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        if(sel && parseInt(sel.value) === item.a) {
          score++;
          stats[item.l]++;
        } else {
          wrongs.push({ q: item.q, user: sel ? item.o[sel.value] : "Ch∆∞a tr·∫£ l·ªùi" });
        }
      });

      // L∆ØU V√ÄO C∆† S·ªû D·ªÆ LI·ªÜU (localStorage)
      saveToDB(score, stats);

      document.getElementById('quiz-section').style.display = 'none';
      document.getElementById('result-section').style.display = 'block';
      document.getElementById('final-score').innerText = `K·∫øt qu·∫£: ${score}/12 ƒëi·ªÉm`;

      renderRadarChart(stats);
      getAIFeedback(score, stats, wrongs);
    }

    function saveToDB(score, stats) {
      let db = JSON.parse(localStorage.getItem('tin_ai_db') || "[]");
      db.push({ 
        name: studentName, 
        topic: document.getElementById('topic').value, 
        score: score, 
        stats: stats,
        date: new Date().toLocaleString('vi-VN') 
      });
      localStorage.setItem('tin_ai_db', JSON.stringify(db));
    }

    // AI H∆Ø·ªöNG D·∫™N T∆Ø DUY - KH√îNG CHO ƒê√ÅP √ÅN
    async function getAIFeedback(score, stats, wrongs) {
      const feedbackEl = document.getElementById('ai-feedback');
      feedbackEl.innerHTML = "<em>AI Mentor ƒëang nghi√™n c·ª©u l·ªói sai c·ªßa b·∫°n...</em>";
      
      const prompt = `B·∫°n l√† gia s∆∞ AI. H·ªçc sinh ${studentName} l√†m sai c√°c c√¢u sau: ${JSON.stringify(wrongs)}. 
      ƒêi·ªÉm s·ªë: ${score}/12 (Nh·∫≠n bi·∫øt: ${stats.nb}/4, Th√¥ng hi·ªÉu: ${stats.th}/4, V·∫≠n d·ª•ng: ${stats.vd}/4).
      Y√äU C·∫¶U:
      1. KH√îNG TI·∫æT L·ªò ƒê√ÅP √ÅN ƒê√öNG.
      2. Gi·∫£i th√≠ch t·∫°i sao logic c·ªßa h·ªçc sinh ch∆∞a ƒë√∫ng.
      3. G·ª£i √Ω ki·∫øn th·ª©c c·∫ßn ƒë·ªçc l·∫°i v√† ƒë∆∞a ra 1 v√≠ d·ª• t∆∞∆°ng t·ª± ƒë·ªÉ h·ªçc sinh t·ª± gi·∫£i.
      D√πng HTML (b, li) ƒë·ªÉ tr√¨nh b√†y.`;

      try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        const data = await res.json();
        feedbackEl.innerHTML = data.candidates[0].content.parts[0].text;
      } catch {
        feedbackEl.innerHTML = "AI b·∫≠n x·ª≠ l√Ω, h√£y xem l·∫°i c√°c ghi ch√∫ trong s√°ch gi√°o khoa v·ªÅ ph·∫ßn n√†y nh√©!";
      }
    }

    // B√ÅO C√ÅO TI·∫æN B·ªò (D√ÄNH CHO GI√ÅO VI√äN & H·ªåC SINH)
    function showHistory() {
      document.getElementById('setup-section').style.display = 'none';
      document.getElementById('history-section').style.display = 'block';
      const db = JSON.parse(localStorage.getItem('tin_ai_db') || "[]");
      
      const myData = db.filter(i => i.name === document.getElementById('student-name').value || !document.getElementById('student-name').value);
      
      const scores = myData.map(i => i.score);
      const labels = myData.map(i => i.date.split(',')[0]);

      new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'ƒêi·ªÉm s·ªë (thang 12)', data: scores, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3 }] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 12 } } }
      });

      const list = document.getElementById('history-list');
      list.innerHTML = myData.reverse().map(r => `
        <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
          <span><b>${r.name}</b> - ${r.topic}</span>
          <span>ƒêi·ªÉm: <b style="color:var(--blue-600)">${r.score}/12</b> (${r.date})</span>
        </div>
      `).join('');
    }

    function renderRadarChart(stats) {
      new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
          labels: ['Nh·∫≠n bi·∫øt', 'Th√¥ng hi·ªÉu', 'V·∫≠n d·ª•ng'],
          datasets: [{ label: 'S·ªë c√¢u ƒë√∫ng', data: [stats.nb, stats.th, stats.vd], backgroundColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#2563eb', pointBackgroundColor: '#ff6b3d' }]
        },
        options: { scales: { r: { beginAtZero: true, max: 4, ticks: { stepSize: 1 } } } }
      });
    }

    function startTimer() {
      let time = 900;
      const timerEl = document.getElementById('timer');
      const interval = setInterval(() => {
        if(time <= 0 || document.getElementById('quiz-section').style.display === 'none') return clearInterval(interval);
        time--;
        timerEl.innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
      }, 1000);
    }
  </script>
</body>
</html>